# 文件上传

## 概述

+ 文件上传的本质任然是一个数据提交，无非就是数据量大一些而已
+ 在实践中，人们逐渐形成了一种共识。我们自行规定，文件上传默认使用下面的请求格式

  ```txt
  POST 上传地址 HTTP/1.1
  其他请求头
  Content-Type: mutipart/form-data;boundary=----WebkitFormBoundary7MA4YWxkTrZu0gW

  ----WebkitFormBoundary7MA4YWxkTrZu0gW
  Content-Disposition: form-data; name="avatar"; filename="小仙女.jpg"
  Content-Type: image/jpeg

  (文件二进制数据)
  ----WebkitFormBoundary7MA4YWxkTrZu0gW
  Content-Disposition: form-data; name="name"

  ```

+ 除非接口文档特别说明，文件上传一般使用 **POST** 请求
+ 接口文档中会规定上传地址，一般一个站点会有一个统一的上传地址
+ 除非接口文档特别说明 `Content-Type: mutipart/form-data`，浏览器会自动分配界定符 `boundary`
+ 请求体的格式是一个被界定符 `boundary` 分割的消息，每个分割区域本质就是一个键值对
+ 除了键值对外， `mutipart/form-data` 允许添加其他额外信息，比如文件数据区域，一般会把文件在本地的名称和文件MIME类型告诉服务器

## 文件上传的实现

+ 接口文档

  + 路径 `/api/upload`
  + 请求方式 POST
  + 字段名 file
  + 尺寸限制 1M
  + 支持的文件后缀 .jpg .jpeg .gif .png .webp
  + 上传成功响应

    ```js
    {
      code: 0,
      msg: '',
      data: "http://localhost:8000/upload/a32d18.jpg" // 访问路径
    }
    ```

  + 失败响应

    ```js
    {
      code: 403,
      msg: '文件超过了限制',
      data: null
    }
    ```

+ 上传文件

  ```html
  <button id="btnupload">上传文件<button>
  <!-- 隐藏 -->
  <input type="file" id="fileupload" style="display: none;" />
  ```

  ```js
  const btnupload = document.querySelector('#btnupload');
  const fileupload = document.querySelector('#fileupload');

  btnupload.addEventListener("click", () => {
    // 选择文件
    fileupload.click()
  })

  fileupload.addEventListener("change", (e) => {
    console.log(e.target.files[0]);
    console.log(fileupload.files[0]);

    const fd = new FormData();

    // fd.append("file", 文件的二进制数据); // 添加一个键值对
    fd.append("file", fileupload.files[0]); // 添加一个键值对

    fetch("http://localhost:8000/upload_video", {
      method: "POST",
      body: fd
    }).then(res => res.json()).then(data => {
      console.log(data);
    })
  })
  ```
